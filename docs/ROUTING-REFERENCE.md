# ルーティング リファレンス

> このドキュメントはルーティング（経路制御）の基礎を理解するための補足資料です。
> **関連**: Day 1（IP アドレスと疎通確認）、Day 2（スタティックルーティング）

---

## ルーティングとは

ルーティングとは、パケットを宛先ネットワークに向けて**最適な経路で転送する**プロセスです。
ルーターはパケットを受け取ると、宛先 IP アドレスを見てルーティングテーブルを参照し、次にどのインターフェースへ送り出すかを決定します。

```
ホストA                Router                ホストB
  │                     │                     │
  │── パケット送信 ────→│                     │
  │   宛先: 10.0.2.10   │── 転送 ────────────→│
  │                     │  eth1 から送出       │
  │                     │                     │
```

---

## ルーティングテーブル

ルーティングテーブルはルーターの「地図」です。宛先ネットワークごとに、どこへ転送すればよいかが記録されています。

### VyOS でのルーティングテーブル確認

```bash
show ip route
```

出力例:

```
S>* 0.0.0.0/0 [1/0] via 192.168.1.254, eth0
C>* 10.0.1.0/24 is directly connected, eth1
C>* 10.0.2.0/24 is directly connected, eth2
S>* 10.0.3.0/24 [1/0] via 10.0.2.1, eth2
```

### ルートの種類

| 記号 | 種類 | 説明 |
|------|------|------|
| C | Connected | 自分のインターフェースに直接つながっているネットワーク |
| S | Static | 管理者が手動で設定した経路 |
| O | OSPF | OSPF で自動学習した経路 |
| K | Kernel | OS が自動生成した経路 |

- **Connected ルート**はインターフェースに IP を設定すると自動的に追加されます
- **Static ルート**は管理者が明示的に `set protocols static route ...` で追加します
- **OSPF ルート**は OSPF プロトコルが自動的に交換・計算します（→ Day 4）

---

## スタティックルート

### 基本構文

```bash
# 特定のネットワークへのルート
set protocols static route <宛先ネットワーク> next-hop <次のルーターのIP>

# 例: 10.0.3.0/24 へは 10.0.2.1 経由
set protocols static route 10.0.3.0/24 next-hop 10.0.2.1
```

### Next-hop（ネクストホップ）

パケットを次に転送する**隣接ルーターの IP アドレス**です。

```
   10.0.1.0/24         10.0.2.0/24         10.0.3.0/24
      │                   │                   │
 ─────┴───── Router-A ────┴───── Router-B ────┴─────
           .1         .1     .2         .1
```

Router-A から 10.0.3.0/24 へ到達するには:

```bash
# Router-A の設定
set protocols static route 10.0.3.0/24 next-hop 10.0.2.2
```

→ 「10.0.3.0/24 宛のパケットは 10.0.2.2（Router-B）に転送してね」

### デフォルトルート

宛先が特定のルートに一致しないパケットをすべて転送する「最後の砦」です。

```bash
# 0.0.0.0/0 = すべての宛先
set protocols static route 0.0.0.0/0 next-hop 192.168.1.254
```

- インターネット向けの通信で特に重要です
- 「他に一致するルートがなければ、ここに送る」という意味です

---

## Longest Match（最長一致）

ルーティングテーブルに複数の一致するエントリがある場合、**最も具体的な（プレフィックスが長い）ルート**が選ばれます。

```
ルーティングテーブル:
  0.0.0.0/0     → 192.168.1.254 経由
  10.0.0.0/8    → 10.0.1.1 経由
  10.0.2.0/24   → 10.0.1.2 経由
```

宛先が `10.0.2.100` の場合:

1. `0.0.0.0/0` → 一致（/0）
2. `10.0.0.0/8` → 一致（/8）
3. `10.0.2.0/24` → 一致（/24）← **最長一致で選択**

---

## メトリックと Administrative Distance

### メトリック

同じプロトコル内で複数の経路がある場合、メトリック（コスト）が小さい方が優先されます。

- スタティックルートのメトリックはデフォルト 1
- OSPF のメトリックは帯域幅ベースで計算（→ [OSPF-REFERENCE.md](OSPF-REFERENCE.md)）

### Administrative Distance（AD）

異なるプロトコル間で経路が競合した場合、AD の値が小さいプロトコルが優先されます。

| ルートソース | AD 値 |
|-------------|-------|
| Connected | 0 |
| Static | 1 |
| OSPF | 110 |
| RIP | 120 |

例: 同じ `10.0.3.0/24` に対して Static（AD=1）と OSPF（AD=110）の両方がある場合、Static が優先されます。

---

## スタティック vs ダイナミック ルーティング

### いつスタティックルーティングを使うか

| 場面 | 理由 |
|------|------|
| 小規模ネットワーク（2-3拠点） | 管理すべきルートが少ない |
| デフォルトルート | インターネット出口は通常1つ |
| スタブネットワーク | 出口が1つしかない末端拠点 |
| セキュリティ要件 | ルート交換のプロトコルが不要 |

### いつダイナミックルーティングを使うか

| 場面 | 理由 |
|------|------|
| 中〜大規模ネットワーク | 手動管理が困難 |
| 冗長経路がある構成 | 障害時の自動切り替え |
| ネットワーク変更が頻繁 | 自動で経路情報を更新 |
| マルチベンダー環境 | 標準プロトコルで相互運用 |

---

## よくあるトラブルと対処

### 1. ルートが存在しない

```bash
# 症状: ping が通らない
# 確認: ルーティングテーブルにエントリがあるか
show ip route

# 対処: スタティックルートを追加
set protocols static route 10.0.3.0/24 next-hop 10.0.2.2
```

### 2. 片方向しか通信できない

**往路**はあるが**復路**がないパターンです。

```
Router-A → Router-B: ルートあり ✓
Router-B → Router-A: ルートなし ✗  ← 戻りの経路を忘れている
```

→ 両方のルーターに、互いのネットワークへのルートを設定する必要があります。

### 3. 非対称ルーティング

行きと帰りで異なる経路を通る状態です。通常は問題ありませんが、ステートフルファイアウォール環境では通信が遮断される場合があります。

### 4. ブラックホールルート

ルートは存在するが、next-hop が到達不能な状態です。

```bash
# 確認: next-hop への到達性をチェック
ping <next-hop のIP>
```

---

## 用語集

| 用語 | 説明 |
|------|------|
| ルーティング | パケットを宛先に向けて転送する経路制御 |
| ルーティングテーブル | 宛先ネットワークと転送先の対応表 |
| Next-hop | パケットを次に転送する隣接ルーターの IP |
| デフォルトルート | 一致するルートがない場合の転送先（0.0.0.0/0） |
| Connected ルート | 直接接続されたネットワークの自動生成ルート |
| Longest Match | 最も具体的なルートを優先する仕組み |
| Administrative Distance | ルーティングプロトコル間の優先度 |
| メトリック | 同一プロトコル内での経路コスト |
| 収束（Convergence） | ネットワーク変更後、全ルーターのテーブルが一致するまでの過程 |

---

## 関連ドキュメント

- [NETWORK-FUNDAMENTALS.md](NETWORK-FUNDAMENTALS.md) - ネットワーク基礎
- [OSPF-REFERENCE.md](OSPF-REFERENCE.md) - OSPF（動的ルーティング）
- [ABOUT-VYOS.md](ABOUT-VYOS.md) - VyOS の CLI 操作
