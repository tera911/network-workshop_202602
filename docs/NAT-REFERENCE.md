# NAT リファレンス

> このドキュメントは NAT（Network Address Translation）の理解を深めるための補足資料です。
> **関連**: Day 5（NAT）

---

## NAT とは

NAT（Network Address Translation）は、パケットの IP アドレスを**別の IP アドレスに変換する技術**です。
主にプライベート IP アドレスを持つ内部ネットワークの機器が、インターネット（グローバル IP）と通信するために使われます。

### なぜ NAT が必要か

- IPv4 アドレスは約43億個しかなく、すべての機器にグローバル IP を割り当てることは不可能です
- RFC 1918 で定義されたプライベート IP アドレス（10.x.x.x, 172.16.x.x, 192.168.x.x）はインターネット上でルーティングされません
- NAT により、少数のグローバル IP で多数の内部機器がインターネット通信可能になります

```
内部ネットワーク              NAT ルーター           インターネット
192.168.1.0/24                                    203.0.113.0/24
                          ┌─────────┐
  PC-A (.10) ─────────────│ 内部  外部│──────────── Web サーバー
  PC-B (.20) ─────────────│ .1   .1  │             203.0.113.100
  PC-C (.30) ─────────────│         │
                          └─────────┘
                        192.168.1.1  203.0.113.1
```

---

## NAT の種類

### 1. Source NAT（SNAT）

**送信元アドレスを変換**します。内部 → 外部への通信で使用します。

```
変換前: 送信元 192.168.1.10 → 宛先 203.0.113.100
変換後: 送信元 203.0.113.1  → 宛先 203.0.113.100
                ↑ ルーターの外部 IP に変換
```

### 2. Masquerade（マスカレード）

SNAT の一種で、**外部インターフェースの IP アドレスを自動的に使用**します。
DHCP などで外部 IP が変わる環境で便利です。

```bash
# VyOS での Masquerade 設定
set nat source rule 100 outbound-interface name eth0
set nat source rule 100 source address 192.168.1.0/24
set nat source rule 100 translation address masquerade
```

### 3. Destination NAT（DNAT）

**宛先アドレスを変換**します。外部 → 内部への通信（ポートフォワーディング）で使用します。

```
変換前: 送信元 203.0.113.50 → 宛先 203.0.113.1:80
変換後: 送信元 203.0.113.50 → 宛先 192.168.1.10:80
                                    ↑ 内部の Web サーバーへ転送
```

```bash
# VyOS での DNAT 設定（ポートフォワーディング）
set nat destination rule 100 inbound-interface name eth0
set nat destination rule 100 destination port 80
set nat destination rule 100 protocol tcp
set nat destination rule 100 translation address 192.168.1.10
```

### 4. PAT / NAPT（Port Address Translation）

1つのグローバル IP で複数の内部ホストが通信できるように、**ポート番号も変換**します。
家庭用ルーターで一般的に使われている方式です。

```
PC-A (192.168.1.10:50001) → NAT → 203.0.113.1:10001 → Web サーバー
PC-B (192.168.1.20:50002) → NAT → 203.0.113.1:10002 → Web サーバー
                                   ↑ 同じ IP、異なるポート
```

### 種類の比較

| 種類 | 方向 | アドレス変換 | ポート変換 | 用途 |
|------|------|------------|----------|------|
| Static NAT | 双方向 | 1対1 固定 | なし | サーバー公開 |
| Dynamic NAT | 内→外 | プールから割当 | なし | 一時的な外部通信 |
| PAT/NAPT | 内→外 | 多対1 | あり | 一般的なインターネット接続 |
| Masquerade | 内→外 | 多対1（自動） | あり | 動的 IP 環境 |
| DNAT | 外→内 | 1対1 | あり/なし | ポートフォワーディング |

---

## NAT テーブル

NAT ルーターは変換の対応関係を **NAT テーブル** に記録します。
これにより、戻りのパケットを正しく元のアドレスに変換できます。

```
NAT テーブルの例:
┌──────────────────────┬───────────────────┬──────────────────┐
│ 内部アドレス:ポート    │ 外部アドレス:ポート  │ 宛先              │
├──────────────────────┼───────────────────┼──────────────────┤
│ 192.168.1.10:50001   │ 203.0.113.1:10001 │ 93.184.216.34:80 │
│ 192.168.1.20:50002   │ 203.0.113.1:10002 │ 93.184.216.34:80 │
└──────────────────────┴───────────────────┴──────────────────┘
```

VyOS での確認:

```bash
# NAT テーブルの確認
show nat source translations
show nat destination translations
```

---

## メリットとデメリット

| メリット | デメリット |
|---------|----------|
| IPv4 アドレスの節約 | End-to-End 接続性の喪失 |
| 内部構成の隠蔽（セキュリティ） | 一部プロトコルが動作しない（FTP, SIP 等） |
| ネットワーク再構成の柔軟性 | トラブルシューティングが複雑に |
| | パフォーマンスへの影響（変換処理） |

---

## 実環境での活用

| 場面 | NAT の種類 | 説明 |
|------|-----------|------|
| 家庭ルーター | PAT/Masquerade | 複数台の PC が1つのグローバル IP でインターネット利用 |
| 企業出口 | SNAT + PAT | 社内ネットワークからの外部通信 |
| サーバー公開 | DNAT | 外部から内部 Web サーバーへのアクセス |
| クラウド | Cloud NAT | VPC 内のインスタンスからの外部通信 |

---

## よくあるトラブルと対処

### 1. 外部への通信ができない

```bash
# 確認ポイント
show nat source rules        # NAT ルールが設定されているか
show nat source translations # 変換が実行されているか

# よくある原因
# - outbound-interface の指定が間違っている
# - source address の範囲が間違っている
# - NAT ルールが適用される前にパケットがドロップされている
```

### 2. 戻りパケットが届かない

```
症状: 外部サーバーには到達するが、応答が返ってこない
原因: NAT ルーターにルートがない、またはファイアウォールでブロック
確認: tcpdump で外部インターフェースを確認
```

```bash
# 外部側でパケットキャプチャ
sudo tcpdump -i eth0 -n host 203.0.113.100
```

### 3. DNAT が動作しない

```
確認ポイント:
  1. inbound-interface は正しいか
  2. destination port / protocol は正しいか
  3. translation address の内部サーバーは起動しているか
  4. ファイアウォールで内部への通信が許可されているか
```

---

## 用語集

| 用語 | 説明 |
|------|------|
| NAT | Network Address Translation。アドレス変換技術 |
| SNAT | Source NAT。送信元アドレスの変換 |
| DNAT | Destination NAT。宛先アドレスの変換 |
| PAT/NAPT | Port Address Translation。ポート番号も含めた変換 |
| Masquerade | 外部 IF の IP を自動的に使う SNAT |
| NAT テーブル | アドレス変換の対応表 |
| ポートフォワーディング | 外部からの特定ポートを内部サーバーへ転送 |
| RFC 1918 | プライベート IP アドレスの範囲を定義した標準 |

---

## 関連ドキュメント

- [NETWORK-FUNDAMENTALS.md](NETWORK-FUNDAMENTALS.md) - IP アドレスの基礎
- [FIREWALL-REFERENCE.md](FIREWALL-REFERENCE.md) - ファイアウォール（NAT と組み合わせて使用）
- [ABOUT-VYOS.md](ABOUT-VYOS.md) - VyOS の CLI 操作
