# VLAN リファレンス

> このドキュメントは VLAN（Virtual LAN）の理解を深めるための補足資料です。
> **関連**: Day 3（VLAN）、Day 8（Inter-VLAN ルーティング）

---

## VLAN とは

VLAN（Virtual LAN）は、物理的なネットワーク構成に関係なく、**論理的にネットワークを分割する技術**です。
1台のスイッチ上で複数の独立したブロードキャストドメインを作ることができます。

### VLAN がない場合

```
┌─────────────────────────────┐
│          スイッチ             │
│                             │
│  PC-A  PC-B  PC-C  PC-D    │  ← 全員が同じブロードキャストドメイン
│                             │    → 全員に通信が届く
└─────────────────────────────┘
```

### VLAN がある場合

```
┌─────────────────────────────┐
│          スイッチ             │
│                             │
│  ┌─VLAN 10──┐ ┌─VLAN 20──┐ │
│  │ PC-A     │ │ PC-C     │ │  ← 論理的に分離
│  │ PC-B     │ │ PC-D     │ │    → 異なる VLAN 間は通信不可
│  └──────────┘ └──────────┘ │
└─────────────────────────────┘
```

---

## なぜ VLAN が必要か

| 理由 | 説明 |
|------|------|
| **セキュリティ** | 部署間のトラフィックを分離し、不正アクセスを防止 |
| **ブロードキャスト抑制** | ブロードキャストの範囲を限定し、帯域を節約 |
| **柔軟な設計** | 物理的な場所に依存しないネットワーク構成が可能 |
| **管理の簡素化** | 配線を変えずにネットワーク構成を変更可能 |

---

## 動作原理

### アクセスポートとトランクポート

| ポート種別 | 役割 | VLAN タグ |
|-----------|------|----------|
| **アクセスポート** | 1つの VLAN にのみ所属。PC やサーバーを接続 | タグなし（Untagged） |
| **トランクポート** | 複数の VLAN のトラフィックを通す。スイッチ間やルーター接続に使用 | タグあり（Tagged） |

```
  PC-A          スイッチ            ルーター
   │              │                  │
   │  アクセス     │     トランク      │
   │──(VLAN 10)──│══(VLAN 10,20)══│
   │  タグなし     │    タグあり       │
```

### 802.1Q タグ

トランクポートでは、イーサネットフレームに **4バイトの VLAN タグ** が挿入されます。

```
通常のイーサネットフレーム:
┌──────────┬──────────┬──────┬──────┬─────┐
│ 宛先MAC  │ 送信元MAC │ Type │ Data │ FCS │
└──────────┴──────────┴──────┴──────┴─────┘

802.1Q タグ付きフレーム:
┌──────────┬──────────┬──────────┬──────┬──────┬─────┐
│ 宛先MAC  │ 送信元MAC │ 802.1Qタグ │ Type │ Data │ FCS │
└──────────┴──────────┴──────────┴──────┴──────┴─────┘
                       │
                       ├─ TPID: 0x8100（802.1Q を示す）
                       ├─ Priority: QoS 優先度（3ビット）
                       ├─ CFI: 1ビット
                       └─ VLAN ID: 12ビット（0-4095）
```

- VLAN ID は 12ビット → 最大 4,094 個の VLAN を定義可能（0 と 4095 は予約）
- 実際によく使われるのは VLAN 1〜1000 程度

---

## VLAN の種類

| 種類 | 説明 |
|------|------|
| **データ VLAN** | 通常のユーザートラフィックを流す VLAN |
| **ネイティブ VLAN** | トランクポートでタグなしフレームが属する VLAN（デフォルトは VLAN 1） |
| **管理 VLAN** | スイッチの管理用 IP を割り当てる VLAN |
| **音声 VLAN** | IP 電話のトラフィック用（QoS 設定と組み合わせ） |

> **注意**: ネイティブ VLAN はセキュリティ上の理由から、デフォルトの VLAN 1 以外に変更することが推奨されます。

---

## Inter-VLAN ルーティング

VLAN で分離されたネットワーク間は、ルーターまたは L3 スイッチを介して通信します。

### Router on a Stick

1本の物理リンク（トランク）で複数の VLAN のトラフィックを処理する構成です。

```
                  トランクリンク
  スイッチ ════════════════════ ルーター
  │                              │
  │  VLAN 10: 192.168.10.0/24   │  eth1.10: 192.168.10.1/24
  │  VLAN 20: 192.168.20.0/24   │  eth1.20: 192.168.20.1/24
  │                              │
```

ルーター側ではサブインターフェースを作成します:

```bash
# VyOS でのサブインターフェース設定
set interfaces ethernet eth1 vif 10 address 192.168.10.1/24
set interfaces ethernet eth1 vif 10 description "Sales VLAN"
set interfaces ethernet eth1 vif 20 address 192.168.20.1/24
set interfaces ethernet eth1 vif 20 description "Development VLAN"
```

- `eth1.10` → VLAN 10 のサブインターフェース
- `eth1.20` → VLAN 20 のサブインターフェース
- 各サブインターフェースが、それぞれの VLAN のゲートウェイになります

### 通信の流れ（VLAN 10 → VLAN 20）

```
1. PC-A (VLAN 10) がパケットをゲートウェイ (192.168.10.1) へ送信
2. スイッチがトランクポートから VLAN 10 タグ付きフレームを送出
3. ルーターが eth1.10 でフレームを受信、VLAN タグを除去
4. ルーターがルーティングテーブルを参照 → eth1.20 へ転送
5. ルーターが VLAN 20 タグを付けてトランクポートへ送出
6. スイッチが VLAN 20 のアクセスポートから PC-C へ転送
```

### L3 スイッチとの比較

| 方式 | メリット | デメリット |
|------|---------|----------|
| Router on a Stick | 既存ルーターを活用可能、シンプル | トランクリンクがボトルネックになりうる |
| L3 スイッチ | ハードウェア処理で高速 | 機器コストが高い |

---

## 実環境での活用例

### 部署別 VLAN 設計例

| VLAN ID | 名前 | ネットワーク | 用途 |
|---------|------|------------|------|
| 10 | Sales | 192.168.10.0/24 | 営業部 |
| 20 | Engineering | 192.168.20.0/24 | 開発部 |
| 30 | Management | 192.168.30.0/24 | 管理部 |
| 100 | Server | 10.0.100.0/24 | サーバーセグメント |
| 999 | Native | - | ネイティブ VLAN（未使用） |

---

## よくあるトラブルと対処

### 1. VLAN mismatch（不一致）

```
症状: 同じ VLAN のはずなのに通信できない
原因: ポートに割り当てた VLAN ID が間違っている
確認: 両端のポート設定を確認
```

### 2. トランク設定ミス

```
症状: 特定の VLAN だけ通信できない
原因: トランクポートで該当 VLAN が許可されていない
確認: トランクポートの allowed VLAN リストを確認
```

### 3. ネイティブ VLAN の不一致

```
症状: トランクリンク経由の通信が不安定
原因: 両端のスイッチでネイティブ VLAN が異なる
対処: 両端で同じネイティブ VLAN を設定
```

### 4. Inter-VLAN ルーティング不可

```
症状: 異なる VLAN 間で通信できない
確認ポイント:
  - ルーターにサブインターフェースが設定されているか
  - 各 VLAN のホストのデフォルトゲートウェイが正しいか
  - トランクリンクが正しく設定されているか
```

---

## 用語集

| 用語 | 説明 |
|------|------|
| VLAN | Virtual LAN。論理的なネットワーク分割 |
| ブロードキャストドメイン | ブロードキャストが届く範囲 |
| アクセスポート | 1つの VLAN に所属するポート |
| トランクポート | 複数の VLAN を通すポート |
| 802.1Q | VLAN タグの標準規格 |
| サブインターフェース | 1つの物理インターフェースを論理的に分割したもの |
| Router on a Stick | 1本のトランクリンクで Inter-VLAN ルーティングを行う構成 |
| ネイティブ VLAN | トランクでタグなしフレームが属する VLAN |
| VLAN タグ | フレームに挿入される VLAN 識別情報（4バイト） |

---

## 関連ドキュメント

- [NETWORK-FUNDAMENTALS.md](NETWORK-FUNDAMENTALS.md) - ネットワーク基礎（MAC アドレス、フレーム）
- [FIREWALL-REFERENCE.md](FIREWALL-REFERENCE.md) - VLAN 間のアクセス制御
- [ABOUT-VYOS.md](ABOUT-VYOS.md) - VyOS の CLI 操作
