# ネットワーク基礎 リファレンス

> このドキュメントはネットワークの基礎概念を理解するための補足資料です。
> **関連**: 全 Day 共通（特に Day 1〜3 の土台となる知識）

---

## OSI 参照モデルと TCP/IP モデル

ネットワーク通信は「層（レイヤー）」に分けて理解します。

### OSI 参照モデル（7層）

| レイヤー | 名前 | 役割 | 代表的なプロトコル/機器 |
|---------|------|------|----------------------|
| L7 | アプリケーション層 | ユーザーが直接触れる通信 | HTTP, DNS, DHCP |
| L6 | プレゼンテーション層 | データ形式の変換・暗号化 | SSL/TLS, JPEG |
| L5 | セッション層 | 通信の開始・維持・終了 | NetBIOS |
| L4 | トランスポート層 | 端末間の信頼性ある通信 | TCP, UDP |
| L3 | ネットワーク層 | 異なるネットワーク間の転送 | IP, ICMP, OSPF |
| L2 | データリンク層 | 同一ネットワーク内の転送 | Ethernet, 802.1Q |
| L1 | 物理層 | 電気信号・光信号の伝送 | ケーブル, コネクタ |

### TCP/IP モデル（4層）

実務では OSI よりも TCP/IP モデルがよく使われます。

```
┌─────────────────────┐
│   アプリケーション層    │  ← HTTP, DNS, DHCP（OSI L5-L7）
├─────────────────────┤
│   トランスポート層      │  ← TCP, UDP（OSI L4）
├─────────────────────┤
│   インターネット層      │  ← IP, ICMP（OSI L3）
├─────────────────────┤
│   ネットワークアクセス層  │  ← Ethernet, Wi-Fi（OSI L1-L2）
└─────────────────────┘
```

### このワークショップで扱うレイヤー

| Day | 主に扱うレイヤー | 内容 |
|-----|----------------|------|
| Day 1 | L3 | IP アドレス、ping |
| Day 2 | L3 | スタティックルーティング |
| Day 3 | L2 | VLAN |
| Day 4 | L3 | OSPF（動的ルーティング） |
| Day 5 | L3 | NAT |
| Day 6 | L7 / L3 | DHCP, DNS |
| Day 7 | L3-L4 | ファイアウォール |
| Day 8 | L2-L3 | Inter-VLAN ルーティング |
| Day 9 | L3 | VPN（WireGuard） |
| Day 10 | 全レイヤー | トラブルシューティング |

---

## IP アドレスの深掘り

### IP アドレスの構造

IPv4 アドレスは **32ビット** の数値で、8ビットずつ4つに区切って10進数で表記します。

```
10進数表記:   192  .  168  .   1   .   1
2進数表記: 11000000.10101000.00000001.00000001
```

### サブネットマスクとプレフィックス長

サブネットマスクは、IP アドレスの「ネットワーク部」と「ホスト部」を区別します。

```
IP アドレス:     192.168.1.100
サブネットマスク:  255.255.255.0（= /24）

ネットワーク部:   192.168.1.  （先頭24ビット）
ホスト部:                  100（残り8ビット）
```

### よく使うプレフィックス長

| CIDR | サブネットマスク | ホスト数 | 用途 |
|------|---------------|---------|------|
| /8 | 255.0.0.0 | 約1677万 | 大規模ネットワーク |
| /16 | 255.255.0.0 | 65,534 | 中規模ネットワーク |
| /24 | 255.255.255.0 | 254 | 一般的な LAN |
| /30 | 255.255.255.252 | 2 | ルーター間リンク |
| /32 | 255.255.255.255 | 1 | ホストルート（自分自身） |

### プライベート IP アドレスとグローバル IP アドレス

| 種類 | 範囲 | 用途 |
|------|------|------|
| クラスA プライベート | 10.0.0.0/8 | 大規模内部ネットワーク |
| クラスB プライベート | 172.16.0.0/12 | 中規模内部ネットワーク |
| クラスC プライベート | 192.168.0.0/16 | 家庭・小規模オフィス |
| グローバル IP | 上記以外 | インターネット上で一意 |

- プライベート IP はインターネットに直接出られません（NAT が必要 → Day 5）
- RFC 1918 で定義されています

### 特殊な IP アドレス

| アドレス | 意味 |
|---------|------|
| 0.0.0.0 | 「すべてのネットワーク」（デフォルトルートで使用） |
| 127.0.0.1 | ループバック（自分自身への通信テスト用） |
| 255.255.255.255 | ブロードキャスト（同一ネットワーク全体への送信） |
| 169.254.x.x | リンクローカル（DHCP 取得失敗時に自動設定） |

---

## プロトコルの基礎

### TCP と UDP の違い

| 特徴 | TCP | UDP |
|------|-----|-----|
| 接続 | コネクション型（3-way handshake） | コネクションレス |
| 信頼性 | あり（再送、順序保証） | なし |
| 速度 | やや遅い | 高速 |
| 用途 | Web(HTTP), メール, SSH | DNS, DHCP, VoIP, WireGuard |

### TCP の 3-way ハンドシェイク

```
クライアント                サーバー
    │                        │
    │──── SYN ──────────────→│  1. 接続要求
    │                        │
    │←─── SYN + ACK ────────│  2. 接続承諾
    │                        │
    │──── ACK ──────────────→│  3. 確認応答
    │                        │
    │      通信開始           │
```

### ICMP（Internet Control Message Protocol）

ネットワークの状態を通知するプロトコルです。`ping` や `traceroute` で使用されます。

| タイプ | 名前 | 用途 |
|--------|------|------|
| 0 | Echo Reply | ping の応答 |
| 8 | Echo Request | ping の要求 |
| 3 | Destination Unreachable | 到達不能通知 |
| 11 | Time Exceeded | TTL 超過（traceroute で利用） |

### よく使うポート番号

| ポート | プロトコル | サービス |
|--------|----------|---------|
| 22 | TCP | SSH |
| 53 | TCP/UDP | DNS |
| 67-68 | UDP | DHCP |
| 80 | TCP | HTTP |
| 443 | TCP | HTTPS |
| 51820 | UDP | WireGuard |

---

## パケットの流れ

### カプセル化（Encapsulation）

データは各レイヤーで「ヘッダー」が追加されて送信されます。

```
アプリケーション:  [データ]
トランスポート:    [TCPヘッダー][データ]          → セグメント
ネットワーク:      [IPヘッダー][TCPヘッダー][データ]  → パケット
データリンク:      [Ethヘッダー][IPヘッダー][TCPヘッダー][データ][FCS] → フレーム
```

### MAC アドレスと IP アドレスの役割の違い

| | MAC アドレス | IP アドレス |
|---|-------------|-----------|
| レイヤー | L2（データリンク層） | L3（ネットワーク層） |
| 範囲 | 同一ネットワーク内 | ネットワーク間 |
| 変化 | ホップごとに変わる | 送信元から宛先まで不変 |
| 例え | 「今の区間の届け先」 | 「最終目的地」 |

### ARP（Address Resolution Protocol）

IP アドレスから MAC アドレスを解決するプロトコルです。

```
ホストA (192.168.1.10)           ホストB (192.168.1.20)
    │                                │
    │── ARP Request（ブロードキャスト）─→│  「192.168.1.20 の MAC は？」
    │                                │
    │←── ARP Reply（ユニキャスト）─────│  「私の MAC は AA:BB:CC:DD:EE:FF」
    │                                │
    │   ARP テーブルに記録            │
```

VyOS での確認コマンド:

```bash
# ARP テーブルの確認
show arp
```

---

## よくあるトラブルと対処

| 症状 | 原因の可能性 | 確認方法 |
|------|-------------|---------|
| ping が通らない | IP アドレスが異なるネットワーク | `show interfaces` で確認 |
| 片方向のみ通信可能 | 戻りルートがない | 両端で `show ip route` を確認 |
| 同一セグメントなのに通信不可 | サブネットマスクの不一致 | 両端の /XX を確認 |
| 169.254.x.x になる | DHCP サーバーに到達できない | DHCP サーバーの状態を確認 |

---

## 用語集

| 用語 | 説明 |
|------|------|
| LAN | Local Area Network。同一建物内のネットワーク |
| WAN | Wide Area Network。拠点間を結ぶ広域ネットワーク |
| ホップ | パケットがルーターを1つ通過すること |
| TTL | Time To Live。パケットの寿命（ホップ数で減少） |
| MTU | Maximum Transmission Unit。1フレームの最大サイズ（通常1500バイト） |
| ブロードキャスト | 同一ネットワーク全体への一斉送信 |
| ユニキャスト | 特定の1台への送信 |
| ゲートウェイ | 他のネットワークへの出口となるルーター |

---

## 関連ドキュメント

- [ROUTING-REFERENCE.md](ROUTING-REFERENCE.md) - ルーティングの基礎
- [VLAN-REFERENCE.md](VLAN-REFERENCE.md) - VLAN の基礎
- [ABOUT-VYOS.md](ABOUT-VYOS.md) - VyOS の概要と CLI 操作
