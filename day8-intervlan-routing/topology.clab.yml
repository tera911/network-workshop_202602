# Day 8: Inter-VLAN ルーティング - 完成版トポロジ
#
# 構成（ルーター・オン・ア・スティック）:
#              [router-gw]
#                  │ (トランク: VLAN 10 + 20)
#              [switch]
#             /  |  |  \
#    [host1] [host2] [host3] [host4]
#     VL10    VL20    VL10    VL20
#
# ネットワーク設計:
#   VLAN 10（営業部）: 192.168.10.0/24
#   VLAN 20（開発部）: 192.168.20.0/24
#
# 使い方:
#   1. sudo containerlab deploy -t topology.clab.yml
#   2. ./setup-complete.sh  # 設定投入スクリプト実行

name: day8-intervlan-routing

topology:
  nodes:
    # ルーター（VyOS - サブインターフェースで VLAN 間ルーティング）
    router-gw:
      kind: linux
      image: ghcr.io/vyos/vyos:current

    # L2 スイッチ（Linux Bridge + VLAN トランク）
    switch:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache bridge-utils iproute2
        # VLAN 10 用ブリッジ
        - ip link add br-vlan10 type bridge
        - ip link set br-vlan10 up
        # VLAN 20 用ブリッジ
        - ip link add br-vlan20 type bridge
        - ip link set br-vlan20 up
        # アクセスポート
        - ip link set eth1 master br-vlan10   # host1 (VLAN10)
        - ip link set eth2 master br-vlan20   # host2 (VLAN20)
        - ip link set eth3 master br-vlan10   # host3 (VLAN10)
        - ip link set eth4 master br-vlan20   # host4 (VLAN20)
        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up
        - ip link set eth4 up
        # トランクポート（router-gw への 802.1Q タグ付きリンク）
        - ip link add link eth5 name eth5.10 type vlan id 10
        - ip link add link eth5 name eth5.20 type vlan id 20
        - ip link set eth5.10 master br-vlan10
        - ip link set eth5.20 master br-vlan20
        - ip link set eth5 up
        - ip link set eth5.10 up
        - ip link set eth5.20 up

    # VLAN 10 のホスト（営業部）
    host1:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.10.11/24 dev eth1
        - ip route replace default via 192.168.10.1
        - ip link set eth1 up

    host3:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.10.13/24 dev eth1
        - ip route replace default via 192.168.10.1
        - ip link set eth1 up

    # VLAN 20 のホスト（開発部）
    host2:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.20.12/24 dev eth1
        - ip route replace default via 192.168.20.1
        - ip link set eth1 up

    host4:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.20.14/24 dev eth1
        - ip route replace default via 192.168.20.1
        - ip link set eth1 up

  links:
    - endpoints: ["switch:eth1", "host1:eth1"]
    - endpoints: ["switch:eth2", "host2:eth1"]
    - endpoints: ["switch:eth3", "host3:eth1"]
    - endpoints: ["switch:eth4", "host4:eth1"]
    - endpoints: ["switch:eth5", "router-gw:eth1"]
